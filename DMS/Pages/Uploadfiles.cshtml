@page
@{
    ViewData["Title"] = "Uploadfiles";
}

<style>
    body {
        display: block;
    }

    .file-uploader-block {
        width: 350px;
        float: left;
    }

    .note {
        font-size: 10pt;
        color: #484848;
        margin-left: 9px;
    }

        .note > span {
            font-weight: 700
        }

    .main-block {
        max-width: 900px;
        min-width: 700px;
        margin-left: 5rem;
    }

    .savebutton {
        float: left;
    }
</style>

<div class="main-block">
    <form id="form" action="javascript:upload()" method="post" enctype="multipart/form-data">
        <h3>Profile Settings</h3>
        <div class="dx-fieldset">
            <div class="dx-field">
                <div class="dx-field-label">Categories:</div>
                <div class="dx-field-value">
                    @(Html.DevExtreme().TagBox()
.DataSource(d => d.Mvc()
        .Controller("Categories")
        .LoadAction("Get")
        .Key("AutoKey")
    )
.DisplayExpr("Name")
.ValueExpr("AutoKey")
.ID("categoriesTagBox")
.Name("categoriesTagBox")
         .SearchExpr("Name")
         .HideSelectedItems(true)
         .OnSelectionChanged("onValueChanged")
         .ShowClearButton(true)
                   .SearchEnabled(true)
                    )
                </div>
            </div>
            <div class="dx-field">
                <div class="dx-field-label">Contacts:</div>
                <div class="dx-field-value">
                    @(Html.DevExtreme().TagBox()
    .DataSource(d => d.Mvc()
               .Controller("Contacts")
               .LoadAction("Get")
               .Key("AutoKey")
           )
    .DisplayExpr("Name")
    
.ID("contactsTagBox")
.Name("contactsTagBox")
    .ValueExpr("AutoKey")
    .HideSelectedItems(true)
    .ShowClearButton(true)
    .OnSelectionChanged("getContacts")
    .SearchExpr("Name")
              .SearchEnabled(true)
                    )
                </div>
            </div>
        </div>
        <div id="fileuploader-container">
            @(Html.DevExtreme().FileUploader()
                .Name("Photo")
                .ID("File")
                .SelectButtonText("Select file")
                .LabelText("")
                .Accept("*")
                .Multiple(true)
                .UploadMode(FileUploadMode.UseForm)
            )
        </div>
        @(Html.DevExtreme().Button()
            .ID("button")
            .Text("Upload file")
            .Type(ButtonType.Success)
            .UseSubmitBehavior(true)
        )
    </form>
</div>

<script src="~/js/tagbox.min.js"></script>
<script>
    var file;
    var categories;
    var contacts;
    function onValueChanged(e) {
        categories = e.component._selectedItems;
        //console.log(e.component._selectedItems);
    }
    function getContacts(e) {
        contacts = e.component._selectedItems;
    }

    $(document).ready(function () {
        $("#File").change(function (e) {
            file = e.target.files[0];
            console.log(file)
        })
    })
    function upload() {

        const xhr = new XMLHttpRequest();

        xhr.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                console.log("1");
            }
        }
        const fd = new FormData();
        fd.append('photo', file);
        fd.append('categories', JSON.stringify(categories))
        fd.append('contacts', JSON.stringify(contacts));
        xhr.open("POST", "api/upload", true);
        xhr.send(fd);
    }
</script>