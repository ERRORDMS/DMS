@page
@{
    ViewData["Title"] = "AddCategory";
}

<head>
    <style>
        .submit {
            margin-left: 8rem;
        }
    </style>
</head>

<div>
    <form action="javascript:addCategory()">
        <div class="dx-field-value">
            @(Html.DevExtreme().TextBox()
                .Mode(TextBoxMode.Text)
                .Name("CategoryName")
                .Placeholder("Category Name")
                .HoverStateEnabled(true)
            )
            @(Html.DevExtreme().DropDownBox()
                .ValueExpr("AutoKey")
                .DisplayExpr("Text")
                .DropDownOptions(o => o.Height(350))
                .DataSource(d => d.Mvc()
                    .Controller("Categories")
                    .LoadAction("Get")
                    .Key("AutoKey")
                )
                .Placeholder("Select parent category")
                .OnValueChanged("getparent")
                .ShowClearButton(true)
                .ContentTemplate(new TemplateName("EmbeddedTreeViewSingle"))
            )


            @using (Html.DevExtreme().NamedTemplate("EmbeddedTreeViewSingle"))
            {
                @(Html.DevExtreme().TreeView()
        .DataSource(new JS(@"component.option(""dataSource"")"))
        .KeyExpr("AutoKey")
        .DisplayExpr("Name")
        .ItemsExpr("Items")
        .ExpandedExpr("Expanded")
        .ParentIdExpr("FatherID")
        .DataStructure(TreeViewDataStructure.Plain)
        .SelectionMode(NavSelectionMode.Single)
        .SelectByClick(true)
        .Height(235)
        .OnItemSelectionChanged(@<text>
                    function(args) {
                    var nodes = args.component.getNodes(),
                    value = getSelectedItemsKeys(nodes);

                    component.option("value", value);
                    }
        </text>)
.OnContentReady(@<text>
            function(args) {
            syncTreeViewSelection(args.component, component.option("value"));
            }
</text>)
                )
            }

        </div>
        <br />
        <br />
        <input type="submit" value="Add Category" class="submit" />
    </form>
    <div class="Category_found" style="display: none">
        the Category already exists
    </div>
    <div class="server_error" style="display: none;">
        Internal Server Error
    </div>
</div>

<script>
    function syncTreeViewSelection(treeView, value) {
        if (!value) {
            treeView.unselectAll();
        } else {
            treeView.selectItem(value);
        }
    }

    function getSelectedItemsKeys(items) {
        var result = [];
        items.forEach(function (item) {
            if (item.selected) {
                result.push(item.key);
            }
            if (item.items.length) {
                result = result.concat(getSelectedItemsKeys(item.items));
            }
        });
        return result;
    }

    var parent;

    function getparent(e) {
        console.log(e);
        parent = e.value;
        console.log(parent);
    }

    function treeBox_valueChanged(e) {
        var $treeView = e.component.content().find(".dx-treeview");
        if ($treeView.length) {
            syncTreeViewSelection($treeView.dxTreeView("instance"), e.value);
        }
    }

    function addCategory() {
        const xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                var t = this.response;
                console.log(t);
                var obj = JSON.parse(t);
                console.log(obj);

                var statusCode = obj.StatusCode;
                if (statusCode == 0) {
                    cosnole.log('SUCCESS');
                    $('.Category_found').fadeOut(100);
                    $(".server_error").fadeOut(100)
                } else {
                    console.log('bad');
                }
                if (statusCode == 103) {
                    console.log('server error');
                    $(document).ready(function () {
                        $(".server_error").fadeIn(100)
                    })
                } else {
                    console.log('error');
                    $(".server_error").fadeOut(100)
                }
                if (statusCode == 105) {
                    console.log('Category found');
                    $('.Category_found').fadeIn(100)
                } else {
                    console.log('the Category not exists');
                    $('.Category_found').fadeOut(100)
                }
            }
        }
        var category = CategoryName.value;
        const fd = new FormData();
        fd.append("Name", category);
        fd.append("FatherID", parent);
        xhr.open("post", "api/Categories/addCategory", true);
        xhr.send(fd);

    }

</script>
